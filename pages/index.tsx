import {BlockButton, FormInput} from '@/components';
import s from '@/styles/HomePage.module.scss';
import {IBlock} from '@/types';
import Head from 'next/head';
import Image from 'next/image';
import {useEffect, useMemo, useState} from 'react';

const BLOCKS: IBlock[] = [
  {block: 'block1', status: false},
  {block: 'block2', status: false},
  {block: 'block3', status: false},
]

export default function HomePage() {

  const wsInstance = useMemo(() => typeof window != 'undefined' ? new WebSocket('wss://taxivoshod.ru:8999') : null, []);
  const [activeBlock, setActiveBlock] = useState<IBlock[]>(BLOCKS);

  useEffect(() => {
    if (wsInstance) wsInstance.onopen = () => console.log('ws connection started');
    if (wsInstance) wsInstance.onclose = () => console.log('ws connection closed');
    
    return () => wsInstance?.close();
  }, []);

  function toggleBlock(name: string) {
    setActiveBlock((v) => v.map((item) => item.block === name ? {...item, status: !item.status} : item));
  }

  return (
    <>
      <Head>
        <title>taxi voshod test task</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={s.main}>

        <div className={s.logo__wrapper} >
          <Image src="/logo.svg" alt="company Logo" className={s.logo} width={275} height={136} priority />
        </div>
        <div className={s.buttons__wrapper} >
          {
            activeBlock.map((block) =>
              <BlockButton key={block.block} block={block} clickHandler={() => toggleBlock(block.block)} />
            )
          }
        </div>
        <div className={s.blocks__wrapper}>
          {
            activeBlock.map((block) =>
              block.status && <FormInput key={block.block} block={block} webSocket={wsInstance} />
            )
          }
        </div>

      </main>
    </>
  )
}
